Sour Daisy Mandrill

High

# Attacker Can Steal ERC20 tokens via Fake Nonces

## Summary
An attacker can exploit the nonce generation mechanism used in the cross-chain messaging system to call finalize bridge ERC20 tokens multiple times. This vulnerability arises from the fact that the nonce used to prevent replay attacks can be manipulated and generated by the attacker, allowing the attacker to call the relayMessage function multiple times with different nonces, thereby bypassing protections against replay attacks.

## Vulnerability Detail
The vulnerability is based on the improper handling of nonces in the cross-chain messaging system, specifically in how they are generated and validated. The key issue lies in the messageNonce() function and the encodeVersionedNonce() function, which are used to generate a versioned nonce that can be manipulated by the attacker.

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/universal/CrossDomainMessenger.sol#L335-L337

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/libraries/Encoding.sol#L115-L121

nonce is used in

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/universal/CrossDomainMessenger.sol#L185-L192

The function encodeVersionedNonce() combines a version and a nonce value to generate the final nonce. However, there is no robust mechanism in place to ensure that the generated nonce is tied to the specific message content or sender in a way that prevents it from being replayed or forged.

This becomes problematic when the attacker calls the relayMessage() function with a manipulated or fake nonce

Since the nonce is part of the hashed message, if the nonce is different, the resulting hash will be different, and the message will be accepted as a new valid message. This allows the attacker to mint tokens repeatedly by calling the relayMessage() function with varying nonces.


## Impact

Finalize BridgeERC20 Exploit: The attacker can mint ERC20 tokens multiple times by repeatedly calling the relayMessage() function with different nonces, effectively bypassing any protections against replay attacks.

Replay Vulnerability: Since the nonce is not properly tied to the specific message or sender, it can be generated or manipulated by the attacker, allowing them to replay messages with modified nonces.

## Code Snippet

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/universal/CrossDomainMessenger.sol#L211-L309

Fake nonces change versionedHash, so relayMessage function can be called several times.
**Nonce is not validated.**

## Attack Scenario

Attacker prepares parameters for 

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/universal/CrossDomainMessenger.sol#L185-L192

Especially, attacker makes fake messageNonce.(Attacker knows the algorithm to make it)

In L1:
https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/L1/L1CrossDomainMessenger.sol#L72-L80

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/L1/OptimismPortal2.sol#L398-L437

In deposittransaction function,

emit TransactionDeposited(from, _to, DEPOSIT_VERSION, opaqueData); 
=> 
L2 relayMessage Function is called.

deposittransaction function is public, so attacker can call this function with prepared parameters.

In L2:

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/L2/L2CrossDomainMessenger.sol#L43-L47

https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/L2/L2ToL1MessagePasser.sol#L73-L92

in initiateWithdrawal function,

emit MessagePassed(messageNonce(), msg.sender, _target, msg.value, _gasLimit, _data, withdrawalHash);
=>
L1 relayMessage Function is called.

initiateWithdrawal function is also public, so attacker can call this function with prepared parameters.

As result, 
https://github.com/sherlock-audit/2024-08-tokamak-network/blob/main/tokamak-thanos/packages/contracts-bedrock/src/universal/StandardBridge.sol#L278-L305

is called and attacker can steal ERC20 tokens bypassing protections against replay attacks and onlyOtherBridge modifier.

## Recommendation
In messageNonce function.
Encoding.encodeVersionedNonce(msgNonce, MESSAGE_VERSION); is used. But it can be generated by attacker.

Consider to verify nonce with CrossDomainMessenger's nonce of other chain.

For example:
If L1's admin and L2's admin are exist, nonce and signature of nonce by admin can be generated.
If user uses nonce and signature generated by admin for _sendMessage's parameters, attacker can't make fake nonces and it can be verified.
